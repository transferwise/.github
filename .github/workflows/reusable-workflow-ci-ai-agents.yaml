name: AI agents in CI

on:
  workflow_call:
    inputs:
      event_name:
        description: "Event name from the caller workflow"
        required: true
        type: string
      event_payload:
        description: "JSON payload captured from the caller event"
        required: true
        type: string
      repository:
        description: "Full repository name of the caller (owner/repo)"
        required: true
        type: string
      ref:
        description: "Git ref from the caller"
        required: true
        type: string
      sha:
        description: "Git SHA from the caller"
        required: true
        type: string
      actor:
        description: "Actor that triggered the caller workflow"
        required: true
        type: string
      failed_run_id:
        description: "Workflow run ID to debug when event_name is workflow_run"
        required: false
        type: number
        default: 0
      team:
        description: "Team name"
        required: false
        type: string
      debug_prompt:
        description: "Detailed prompt for the debug ci failures jobs"
        required: false
        type: string
      debugging_model:
        description: "LLM model to use for debugging failed CI runs"
        required: false
        type: string
      generic_model:
        description: "LLM model to use for general purpose tasks"
        required: false
        type: string

jobs:
  run-ci-ai-agent:
    if: |
      inputs.event_name == 'issues' ||
      inputs.event_name == 'issue_comment' ||
      inputs.event_name == 'pull_request_review_comment' ||
      inputs.event_name == 'pull_request_review'
    runs-on: gha-production-medium
    container: ci-images-release.arti.tw.ee/actions_java_17_and_21
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: "Add repo as safe directory"
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Sync caller event context
        shell: bash
        env:
          CALLER_EVENT_PAYLOAD: ${{ inputs.event_payload }}
        run: |
          event_file="$RUNNER_TEMP/original_event.json"
          printf '%s' "$CALLER_EVENT_PAYLOAD" > "$event_file"
          {
            echo "GITHUB_EVENT_PATH=$event_file"
            echo "GITHUB_EVENT_NAME=${{ inputs.event_name }}"
            echo "GITHUB_REPOSITORY=${{ inputs.repository }}"
            echo "GITHUB_REF=${{ inputs.ref }}"
            echo "GITHUB_SHA=${{ inputs.sha }}"
            echo "GITHUB_ACTOR=${{ inputs.actor }}"
          } >> "$GITHUB_ENV"

      - name: Run AI Agent
        uses: transferwise/claude-code-action@main
        with:
          trigger_phrase: "/run-ci-ai-agents"
          anthropic_bedrock_base_url: ${{ secrets.ANTHROPIC_BEDROCK_BASE_URL }}
          anthropic_default_sonnet_model: ${{ vars.ANTHROPIC_DEFAULT_SONNET_MODEL }}
          anthropic_default_haiku_model: ${{ vars.ANTHROPIC_DEFAULT_HAIKU_MODEL }}
          anthropic_default_opus_model: ${{ vars.ANTHROPIC_DEFAULT_OPUS_MODEL }}
          x-wise-llm-gateway-team: ${{ inputs.team }}
          x-wise-llm-gateway-lite-auth-caller-id: ${{ inputs.actor }}
          experimental_allowed_domains: |
            github.com
            api.github.com
            ${{ secrets.ANTHROPIC_BEDROCK_BASE_URL }}
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment"
            --model ${{ inputs.generic_model != '' && inputs.generic_model || vars.ANTHROPIC_DEFAULT_HAIKU_MODEL }}